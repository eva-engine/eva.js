var t,e;t=this,e=function(t,e,r){"use strict";var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function o(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var i=function(){return(i=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function a(t,e,r,n){var o,i=arguments.length,a=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(i<3?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a}function s(t,e,r,n){return new(r||(r=Promise))((function(o,i){function a(t){try{c(n.next(t))}catch(t){i(t)}}function s(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){t.done?o(t.value):new r((function(e){e(t.value)})).then(a,s)}c((n=n.apply(t,e||[])).next())}))}function c(t,e){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((o=(o=a.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}function p(t){var e="function"==typeof Symbol&&t[Symbol.iterator],r=0;return e?e.call(t):{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}}}var d,u,h,l,v=function(t,e){var r=e.width,n=e.height,o=e.position,i=e.left,a=void 0===i?0:i,s=e.top,c=void 0===s?0:s,p=e.zIndex,d=e.pointerEvents,u=e.background;t.style.width=r+"px",t.style.height=n+"px",t.style.position=o,t.style.left=""+a,t.style.top=""+c,t.style.zIndex=""+p,t.style.pointerEvents=d,t.style.background=u,t.style.border="none",t.style.overflow="hidden"},f=function(t){function r(e){var r=t.call(this)||this;Object.assign(r,e);var n=e.hint,o=void 0===n?"":n,i=e.event,a=e.delay,s=void 0===a?0:a,c=e.attr,p=void 0===c?{}:c,d=e.role,u=void 0===d?"":d,h=e.props,l=void 0===h?{}:h,v=e.state,f=void 0===v?{}:v;return r.hint=o,r.event=i,r.delay=s,r.attr=p,r.role=u,r.props=l,r.state=f,r.a11yId="_"+function(t){for(var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),r=[],n=e.length,o=0;o<t;o++)r[o]=e[0|Math.random()*n];return r.join("")}(6),r}return o(r,t),r.componentName="A11y",a([e.decorators.IDEProp],r.prototype,"interactive",void 0),a([e.decorators.IDEProp],r.prototype,"hint",void 0),a([e.decorators.IDEProp],r.prototype,"event",void 0),a([e.decorators.IDEProp],r.prototype,"delay",void 0),a([e.decorators.IDEProp],r.prototype,"role",void 0),a([e.decorators.IDEProp],r.prototype,"props",void 0),a([e.decorators.IDEProp],r.prototype,"state",void 0),a([e.decorators.IDEProp],r.prototype,"attr",void 0),a([e.decorators.IDEProp],r.prototype,"a11yId",void 0),r}(e.Component),y="absolute";t.A11yActivate=void 0,(d=t.A11yActivate||(t.A11yActivate={}))[d.ENABLE=0]="ENABLE",d[d.DISABLE=1]="DISABLE",d[d.CHECK=2]="CHECK",function(t){t.NONE="none",t.AUTO="auto"}(u||(u={})),function(t){t.DEBUG="rgba(255,0,0,0.5)",t.NONE="transparent"}(h||(h={})),function(t){t.BUTTON="button",t.DIV="div"}(l||(l={}));var g=["hint","event","delay","attr","role","props","state","a11yId","name"],m=function(t,e,r){var n=this;["touchstart","touchend","tap"].forEach((function(o){t.emit(o,{stopPropagation:function(){return r.stopPropagation()},data:{position:n.eventPosition},gameObject:e})}))},E=function(n){function d(t){var e=n.call(this,t)||this;return e.cache=new Map,e.eventCache=new Map,e}return o(d,n),Object.defineProperty(d.prototype,"ratioX",{get:function(){return this._ratioX||this.setRatio()?this._ratioX:0},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"ratioY",{get:function(){return this._ratioY||this.setRatio()?this._ratioY:0},enumerable:!1,configurable:!0}),d.prototype.init=function(e){return void 0===e&&(e={}),s(this,void 0,void 0,(function(){var r,n,o,i,a,s,p,d;return c(this,(function(c){switch(c.label){case 0:switch(r=e.activate,n=void 0===r?t.A11yActivate.CHECK:r,o=e.delay,i=void 0===o?100:o,a=e.checkA11yOpen,s=void 0===a?function(){return Promise.resolve(!1)}:a,this.delay=i,n){case t.A11yActivate.CHECK:return[3,1];case t.A11yActivate.DISABLE:return[3,5];case t.A11yActivate.ENABLE:return[3,6]}return[3,7];case 1:return c.trys.push([1,3,,4]),p=this,[4,s()];case 2:return p.activate=c.sent(),[3,4];case 3:return c.sent(),this.activate=!1,[3,4];case 4:return[3,7];case 5:return this.activate=!1,[3,7];case 6:return this.activate=!0,[3,7];case 7:return this.debug=e.debug||!1,this.debug&&(this.activate=!0),this.activate?(d=document.createElement("div"),this.div=d,this.game.canvas.parentNode&&this.game.canvas.parentNode.appendChild(this.div),[2]):[2]}}))}))},d.prototype.setRatio=function(){var t=this.getCanvasBoundingClientRect(),e=t.width,r=t.height,n=this.getRenderRect(),o=n.renderWidth,i=n.renderHeight;return this._ratioX=e/o,this._ratioY=r/i,!(!e&&!r||(this.initDiv(),0))},d.prototype.getRenderRect=function(){var t=(this.game.getSystem(r.RendererSystem)||{width:300,height:300}).params,e=t.height;return{renderWidth:t.width,renderHeight:e}},d.prototype.getCanvasBoundingClientRect=function(){var t=this.game.canvas.getBoundingClientRect();return{width:t.width,height:t.height,left:t.left,top:t.top}},d.prototype.initDiv=function(){var t=this,e=window.pageXOffset,r=window.pageYOffset,n=this.getCanvasBoundingClientRect(),o={width:n.width,height:n.height,left:n.left+e+"px",top:n.top+r+"px",position:y,zIndex:3,pointerEvents:u.NONE,background:h.NONE};v(this.div,o),this.div.addEventListener("click",(function(e){var r=e.currentTarget.getBoundingClientRect(),n=r.left,o=r.top,i=(e.pageX-n)/t.ratioX,a=(e.pageY-o)/t.ratioY;t.eventPosition={x:i,y:a}}),!0)},d.prototype.update=function(){return s(this,void 0,void 0,(function(){var t,r,n,o,i,a;return c(this,(function(s){if(t=this.componentObserver.clear(),!this.activate)return[2];try{for(r=p(t),n=r.next();!n.done;n=r.next())switch((o=n.value).type){case e.OBSERVER_TYPE.ADD:"Event"===o.componentName&&this.addEvent(o.gameObject),"A11y"===o.componentName&&this.add(o);break;case e.OBSERVER_TYPE.CHANGE:"Transform"===o.componentName&&this.transformChange(o);break;case e.OBSERVER_TYPE.REMOVE:"Event"===o.componentName&&this.removeEvent(o),"A11y"===o.componentName&&this.remove(o)}}catch(t){i={error:t}}finally{try{n&&!n.done&&(a=r.return)&&a.call(r)}finally{if(i)throw i.error}}return[2]}))}))},d.prototype.remove=function(t){var e=t.component;if(e){var r=e.a11yId,n=this.div.querySelector("#"+r);n&&this.div.removeChild(n),this.cache.delete(r)}},d.prototype.add=function(t){var e=this;if(this.activate){var r=t.component,n=t.gameObject,o=r.delay,i=r.a11yId,a=r.event;if(n){var s=n.transform;if(s){var c=document.createElement("div");this.cache.set(i,c),a||(a=n.getComponent("Event")),setTimeout((function(){e.setPosition(c,s),e.setA11yAttr(c,r),a&&e.addEvent(n),n.scene&&e.div.appendChild(c)}),o||this.delay)}}}},d.prototype.transformChange=function(t){var e=t.component,r=t.gameObject.getComponent(f);if(r){var n=r.a11yId;if(e.inScene){if(this.cache.has(n)){var o=this.cache.get(n);o&&this.div.appendChild(o)}}else{var i=this.div.querySelector("#"+n);i&&this.div.removeChild(i)}}},d.prototype.setEvent=function(t,e,r,n){if(e){var o=m.bind(this,e,r);this.eventCache.set(n,o),t.addEventListener("click",o)}},d.prototype.addEvent=function(t){var e=t.getComponent(f);if(e){var r=t.getComponent("Event");if(r){var n=this.cache.get(e.a11yId);n&&this.setEvent(n,r,t,e.a11yId)}}},d.prototype.removeEvent=function(t){var e=t.gameObject.getComponent(f);if(e&&t.component){var r=e.a11yId,n=this.eventCache.get(r),o=this.cache.get(r);o&&o.removeEventListener("click",n)}},d.prototype.setA11yAttr=function(t,e){var r,n,o,i,a,s,c=e.hint,d=e.props,u=void 0===d?{}:d,h=e.state,l=void 0===h?{}:h,v=e.role,f=e.a11yId,y=v||"text";t.setAttribute("role",y),t.setAttribute("aria-label",c),t.id=f;var m=Object.keys(u);try{for(var E=p(m),b=E.next();!b.done;b=E.next()){var A=b.value;t.setAttribute(A,u[A])}}catch(t){r={error:t}}finally{try{b&&!b.done&&(n=E.return)&&n.call(E)}finally{if(r)throw r.error}}var O=Object.keys(l);try{for(var w=p(O),C=w.next();!C.done;C=w.next())A=C.value,t.setAttribute(A,l[A])}catch(t){o={error:t}}finally{try{C&&!C.done&&(i=w.return)&&i.call(w)}finally{if(o)throw o.error}}try{for(var x=p(Object.keys(e)),P=x.next();!P.done;P=x.next())"string"==typeof e[A=P.value]&&-1===g.indexOf(A)&&1!==A.indexOf("_")&&t.setAttribute(A,e[A])}catch(t){a={error:t}}finally{try{P&&!P.done&&(s=x.return)&&s.call(x)}finally{if(a)throw a.error}}},d.prototype.setPosition=function(t,e){var r=e.size,n=r.width,o=r.height,a={width:0===n?1:n*this.ratioX,height:0===o?1:o*this.ratioY,position:y,zIndex:3,pointerEvents:u.AUTO,background:this.debug?h.DEBUG:h.NONE},s=i({},e);v(t,a),function(t,e,r,n){var o=e.worldTransform,i="matrix("+o.a+", "+o.b+", "+o.c+", "+o.d+", "+o.tx*r+", "+o.ty*n+")";t.style.transform=""+i,t.style.webkitTransform=""+i,t.style.transformOrigin="left top",t.style.webkitTransformOrigin="left top"}(t,s,this.ratioX,this.ratioY)},d.prototype.onDestroy=function(){this.div.parentElement.removeChild(this.div),this.cache=null,this.eventCache=null},d.systemName="A11ySystem",d=a([e.decorators.componentObserver({A11y:[],Transform:["inScene"],Event:[]})],d)}(e.System);t.A11y=f,t.A11ySystem=E,Object.defineProperty(t,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@eva/eva.js"),require("@eva/plugin-renderer")):"function"==typeof define&&define.amd?define(["exports","@eva/eva.js","@eva/plugin-renderer"],e):e(((t="undefined"!=typeof globalThis?globalThis:t||self).EVA=t.EVA||{},t.EVA.plugin=t.EVA.plugin||{},t.EVA.plugin.a11y={}),t.EVA,t.EVA.plugin.renderer);
